---
import Base from "../../layouts/Base.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import fs from "fs";
import path from "path";

// === ðŸš€ Gera rotas de categorias no build ===
export async function getStaticPaths() {
  const dir = path.resolve("src/content/blog");
  const files = fs.readdirSync(dir).filter(f => f.endsWith(".md"));

  const categories = new Set();

  for (const file of files) {
    const content = fs.readFileSync(path.join(dir, file), "utf-8");
    const match = content.match(/category:\s*"?(.+?)"?\s*(\r?\n|$)/);
    if (match) {
      const cat = match[1]
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Mn}/gu, "")
        .replace(/\s+/g, "-");
      categories.add(cat);
    }
  }

  return [...categories].map(category => ({ params: { category } }));
}

// === ðŸ—£ï¸ Textos multilÃ­ngues ===
const labels = {
  en: { title: "Category", none: "No posts in this category." },
  es: { title: "CategorÃ­a", none: "No hay publicaciones en esta categorÃ­a." },
  pt: { title: "Categoria", none: "Nenhum post nesta categoria." },
};

const { category } = Astro.params;
const lang = "pt";
const L = labels[lang] || labels.en;

// === ðŸ“‚ Carrega todos os posts do diretÃ³rio ===
const dir = path.resolve("src/content/blog");
const files = fs.readdirSync(dir).filter(f => f.endsWith(".md"));

const posts = [];

for (const file of files) {
  const raw = fs.readFileSync(path.join(dir, file), "utf-8");
  const match = raw.match(/category:\s*"?(.+?)"?\s*(\r?\n|$)/);
  const title = raw.match(/title:\s*"?(.+?)"?\s*(\r?\n|$)/);
  const hero = raw.match(/heroImage:\s*"?(.+?)"?\s*(\r?\n|$)/);
  const date = raw.match(/pubDate:\s*"?(.+?)"?\s*(\r?\n|$)/);

  if (match && match[1]) {
    const slug = match[1]
      .toLowerCase()
      .normalize("NFD")
      .replace(/\p{Mn}/gu, "")
      .replace(/\s+/g, "-");

    posts.push({
      title: title ? title[1] : file,
      category: match[1],
      heroImage: hero ? hero[1] : null,
      pubDate: date ? date[1] : null,
      slug: file.replace(/\.md$/, ""),
      categorySlug: slug,
    });
  }
}

// === ðŸ” Filtra posts da categoria atual ===
const filtered = posts.filter((p) => p.categorySlug === category);

const displayName = filtered[0]?.category || category;
const title = `${L.title}: ${displayName}`;
---

<Base title={title}>
  <section style="padding: 3rem 1rem;">
    <h1 style="text-align:center; font-size:2rem; font-weight:700;">{title}</h1>

    {filtered.length === 0 ? (
      <p style="text-align:center; margin-top:2rem;">{L.none}</p>
    ) : (
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 2rem;
          margin-top: 2rem;
          max-width: 1100px;
          margin-left: auto;
          margin-right: auto;
        "
      >
        {filtered.map((post) => (
          <article style="border-radius: 12px; overflow: hidden; box-shadow: var(--box-shadow); background: white;">
            {post.heroImage && (
              <a href={`/${post.slug}/`}>
                <img
                  src={post.heroImage}
                  alt={post.title}
                  style="width:100%; height:180px; object-fit:cover;"
                />
              </a>
            )}
            <div style="padding:1rem;">
              <h2 style="margin:0;">
                <a
                  href={`/${post.slug}/`}
                  style="color: var(--accent); text-decoration:none; font-weight:600;"
                >
                  {post.title}
                </a>
              </h2>
              <p style="color: gray; font-size:0.9rem; margin-top:0.4rem;">
                {post.pubDate && <FormattedDate date={post.pubDate} />}
              </p>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>
</Base>
