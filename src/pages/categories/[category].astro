---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";
import fs from "fs";

// üöÄ Ativa modo din√¢mico (sem rebuild)
export const prerender = false;

// textos multil√≠ngues
const labels = {
  en: { title: "Category", none: "No posts in this category." },
  es: { title: "Categor√≠a", none: "No hay publicaciones en esta categor√≠a." },
  pt: { title: "Categoria", none: "Nenhum post nesta categoria." },
};

// capturar categoria da URL
const { category } = Astro.params;
const lang = "pt";
const L = labels[lang] || labels.en;

// l√™ categorias do JSON atualizado
let categories = [];
try {
  const json = fs.readFileSync("src/data/categories.json", "utf-8");
  categories = JSON.parse(json);
} catch (err) {
  console.error("Erro ao ler categories.json", err);
}

// encontra categoria correspondente
const currentCat = categories.find(
  (c) => c.slug.toLowerCase() === category.toLowerCase()
);

// se n√£o encontrar categoria
if (!currentCat) {
  return new Response(
    `<h1 style="text-align:center;margin-top:4rem;">${L.title}: ${category}</h1>
     <p style="text-align:center;">${L.none}</p>`,
    { headers: { "Content-Type": "text/html" }, status: 404 }
  );
}

// obt√©m posts em tempo real
const posts = await getCollection("blog");

// filtra os posts por categoria
const filtered = posts.filter(
  (p) =>
    p.data.category &&
    p.data.category.toLowerCase().replace(/\s+/g, "-") ===
      currentCat.slug.toLowerCase()
);

const title = `${L.title}: ${currentCat.name}`;
---

<Base title={title}>
  <section style="padding: 3rem 1rem;">
    <h1 style="text-align:center; font-size:2rem; font-weight:700;">{title}</h1>

    {filtered.length === 0 ? (
      <p style="text-align:center; margin-top:2rem;">{L.none}</p>
    ) : (
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 2rem;
          margin-top: 2rem;
          max-width: 1100px;
          margin-left: auto;
          margin-right: auto;
        "
      >
        {filtered.map((post) => (
          <article style="border-radius: 12px; overflow: hidden; box-shadow: var(--box-shadow); background: white;">
            {post.data.heroImage && (
              <a href={`/${post.slug}/`}>
                <img
                  src={post.data.heroImage}
                  alt={post.data.title}
                  style="width:100%; height:180px; object-fit:cover;"
                />
              </a>
            )}
            <div style="padding:1rem;">
              <h2 style="margin:0;">
                <a
                  href={`/${post.slug}/`}
                  style="color: var(--accent); text-decoration:none; font-weight:600;"
                >
                  {post.data.title}
                </a>
              </h2>
              <p style="color: gray; font-size:0.9rem; margin-top:0.4rem;">
                <FormattedDate date={post.data.pubDate} />
              </p>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>
</Base>
